<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Dual Map Viewer - Final (Optimized)</title>
  <link rel="icon" type="./image/x-icon" href="/images/favicon.ico">
   
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html,body{margin:0;height:100%;font-family:Arial;}
    #controls{display:flex;gap:20px;padding:8px;background:#222;color:#fff;flex-wrap:wrap;align-items:center;}
    .panel{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    #searchInput{width:260px;padding:4px 6px;font-size: 16px; font-family: Arial, sans-serif;}
    #historySelect { width: 140px; height: 28px; padding: 4px 6px; font-size: 15px; margin-left: 5px; }
    #container{display:flex;height:calc(100% - 48px);}
    .map{flex:1;position:relative; border-right: 1px solid #444;}
    .map:last-child{border-right:none;}

    /* Padlet ë§í¬ ìŠ¤íƒ€ì¼ (ìš°ì¸¡ ì •ë ¬) */
    .padlet-link {
        margin-left: auto; 
        color: #4DC4FF;
        text-decoration: none;
        font-size: 14px;
        font-weight: bold;
        padding: 4px 8px;
        border: 1px solid #4DC4FF;
        border-radius: 4px;
        transition: all 0.3s;
    }
    .padlet-link:hover {
        background: #4DC4FF;
        color: #fff;
    }

    /* ìë™ì™„ì„± */
    #suggestList{
      position:absolute;top:36px;left:42%;transform:translateX(-50%);
      width:280px;max-height:600px;overflow-y:auto;background:#fff;
      border:1px solid #888;z-index:2000;display:none;
    }
    #suggestList div{padding:8px 10px;border-bottom:1px solid #eee;cursor:pointer;color:black;font-size: 15px;}
    #suggestList div:hover, #suggestList div.active{background:#cce5ff;}

    /* ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    #leftType, #rightType { padding: 0 12px; font-size: 16px; }
    select#leftSelect, select#rightSelect { width: 86px; height: 26px; padding: 4px 6px; font-size: 15px; }
    #searchBtn, #clearSearchBtn { 
        padding: 1px 12px; 
        height: 28px; 
        line-height: 20px;
        font-size: 13px; 
        min-width: 50px; }

    /* ë¯¸ë‹ˆë§µ ìŠ¤íƒ€ì¼ */
    .minimap-style {
      position: absolute !important;
      width: 25% !important; 
      height: 25% !important;
      min-width: 250px;
      min-height: 200px;
      top: auto !important; bottom: 0; left: 0;
      z-index: 20; border-top: 1px solid #888; border-right: 1px solid #888;
      box-shadow: 2px -2px 5px rgba(0,0,0,0.3);
    }

    /* ë‹«ê¸° ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .close-btn-style {
      position:absolute; top:10px; right:10px; 
      z-index: 10001; 
      transform: translateZ(0); 
      padding:5px 10px; background:#fff; color:#333;
      border:1px solid #ccc; cursor:pointer; border-radius:3px;
      font-weight:bold; font-size: 12px; display:none; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .close-btn-style:hover { background: #f5f5f5; }

    /* ë„¤ì´ë²„ìš© ê±°ë¦¬ë·° ë²„íŠ¼ */
    .street-btn-style {
      position:absolute; top:10px; right:10px; z-index:30;
      padding:5px 10px; background:#fff; border:1px solid #ccc;
      cursor:pointer; border-radius:3px; font-weight:bold; font-size:12px;
      box-shadow:0 2px 4px rgba(0,0,0,0.2); color:#333;
    }

    /* ì¹´ì¹´ì˜¤ GIS íˆ´ë°” ìŠ¤íƒ€ì¼ ê°œì„  */
    .kakao-toolbar{
      position:absolute;top:5px;right:40px;z-index:30;
      background:white;border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex;overflow:hidden;
    }
    .kakao-toolbar button{
      background:#fff; border:0; border-right:1px solid #ddd;
      padding:6px 10px; /* íŒ¨ë”© ì¡°ì • */
      cursor:pointer;
      display: flex; /* ì´ë¯¸ì§€ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
      align-items: center;
      justify-content: center;
      width: 40px; /* ë²„íŠ¼ í¬ê¸° í†µì¼ */
      height: 34px;
    }
    .kakao-toolbar button:last-child{border-right:none;}
    .kakao-toolbar button:hover{background:#f5f5f5;}
    
    /* í™œì„±í™” ìƒíƒœ (ë°°ê²½ íŒŒë€ìƒ‰) */
    .kakao-toolbar button.active{background:#3396ff;}
    
    /* í™œì„±í™” ì‹œ ì´ë¯¸ì§€ ìƒ‰ìƒ ë°˜ì „ (í°ìƒ‰ íš¨ê³¼) */
    .kakao-toolbar button.active img {
        filter: invert(100%);
    }
    .kakao-toolbar button img {
        display: block;
        width: 20px; 
        height: 20px;
        pointer-events: none; /* ì´ë¯¸ì§€ê°€ í´ë¦­ ì´ë²¤íŠ¸ ë°©í•´í•˜ì§€ ì•Šë„ë¡ ì„¤ì • */
    }

    /* ë¡œë“œë·° ìƒíƒœ í‘œì‹œ */
    .roadview-status {
      position:absolute;top:10px;left:10px;z-index:30;
      background:rgba(0,0,0,0.7);color:white;padding:8px 12px;
      border-radius:4px;font-size:13px;font-weight:bold;
    }

    /* ì¸¡ì • ì˜¤ë²„ë ˆì´ */
    .info-overlay{
      background:white;border:1px solid #333;border-radius:4px;
      padding:10px;font-size:12px;
      box-shadow:2px 2px 5px rgba(0,0,0,0.3);white-space:nowrap;
    }
    .measure-label{
      background:#fff;padding:3px 6px;border:1px solid #888;
      border-radius:3px;font-size:11px;color:#333;
      box-shadow:1px 1px 3px rgba(0,0,0,0.2);white-space:nowrap;
    }

    /* ê²€ìƒ‰ ë§ˆì»¤ & ì›Œì»¤ */
    .search-marker {
      width: 24px; height: 32px; margin-left: -12px; margin-top: -32px;
      background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDBMMCAxNiBMNiAxNiBMNiAyNCBMMTIgMjQgTDE4IDE2IEwyNCAxNiBaIiBmaWxsPSIjRkY0MDAwIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9IiNGRkYiLz4KPC9zdmc+') no-repeat;
    }
    .MapWalker{ position:absolute;width:24px;height:24px;margin:-12px 0 0 -12px;pointer-events:none; }
    .MapWalker .angleBack{
      position:absolute;top:50%;left:50%;width:0;height:0;
      border-left:20px solid transparent;border-right:20px solid transparent;
      border-top:40px solid rgba(51,150,255,0.4);
      transform-origin:center bottom;margin-left:-20px;margin-top:-40px;z-index:1;
    }
    .MapWalker .figure{
      position:absolute;top:50%;left:50%;width:0;height:0;
      border-left:8px solid transparent;border-right:8px solid transparent;
      border-bottom:16px solid #ff3300;
      transform-origin:center center;margin-left:-8px;margin-top:-8px;z-index:2;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }
    /* ë„¤ì´ë²„ìš© ì›Œì»¤ */
    .naver-marker-arrow {
      width: 0; height: 0;
      border-left: 10px solid transparent; border-right: 10px solid transparent;
      border-bottom: 24px solid #4DC4FF;
      transform-origin: center center; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
    }
  </style>

  <!-- SDKs -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d2d116d6a534a98e73133808f5843a6&libraries=services,drawing,clusterer"></script>
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=a4kf3r53du&submodules=panorama"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYXu5yKdW71VuKmI-N2M2xbvMaYTK2HCg&callback=init"></script>
</head>

<body>
<div id="controls">
  <div class="panel">
    LEFT:
    <select id="leftSelect"><option value="google">Google</option><option value="kakao">Kakao</option><option value="naver">Naver</option></select>
    <button id="leftType">ì§€ë„/ìœ„ì„±</button>
  </div>
  <div class="panel">
    RIGHT:
    <select id="rightSelect"><option value="google">Google</option><option value="kakao" selected>Kakao</option><option value="naver">Naver</option></select>
    <button id="rightType">ì§€ë„/ìœ„ì„±</button>
  </div>
  <div class="panel" style="position:relative;">
    ê²€ìƒ‰: <input id="searchInput" placeholder="ì£¼ì†Œ ë˜ëŠ” ì§€ëª… ì…ë ¥" autocomplete="off"/>
    <button id="searchBtn">Go</button>
    <button id="clearSearchBtn">ì§€ ì›€</button>
    <select id="historySelect"><option value="">ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡</option></select>
    <div id="suggestList"></div>
  </div>

    <a href="https://padlet.com/googiden/padlet-qr93paqb7efcunwe" target="_blank" class="padlet-link">ì‚¬ìš©í›„ê¸° &gt;</a>
  
</div>

<div id="container">
  <div id="leftMap" class="map"></div>
  <div id="rightMap" class="map"></div>
</div>

<script>
/* ===== ìƒíƒœ ê´€ë¦¬ ===== */
let syncing = false;
let rvSyncing = false; // ë¡œë“œë·° ìœ„ì¹˜ ë™ê¸°í™” ì ê¸ˆ
let state = { lat: 37.5665, lng: 126.9780, zoom: 13 };

/* Side State Objects */
let left = { 
  type: "google", map: null, satellite: true, 
  panorama: null, roadviewActive: false,
  gis: createGisState(),
  naverState: { active: false, streetLayer: null, marker: null },
  searchMarker: null
};
let right = { 
  type: "kakao", map: null, satellite: false, 
  panorama: null, roadviewActive: false,
  gis: createGisState(),
  naverState: { active: false, streetLayer: null, marker: null },
  searchMarker: null
};

/* ê²€ìƒ‰ ê´€ë ¨ ì „ì—­ */
let searchHistory = JSON.parse(localStorage.getItem('mapSearchHistory')) || [];
let kakaoSearchMarker = null; // ë ˆê±°ì‹œ í˜¸í™˜
let activeSuggestIndex = -1;

// ì¹´ì¹´ì˜¤ ì„œë¹„ìŠ¤ ê°ì²´
let kakaoGeocoder = null;
let kakaoPs = null;
let kakaoRvClient = null; 

function createGisState() {
  return {
    mode: 'default',
    waiting: false, 
    drawing: null, 
    path: [],
    overlays: [],
    shapes: [],
    markers: [],
    walker: null,
    statusEl: null
  };
}

function init(){
  if(typeof kakao !== 'undefined' && kakao.maps && kakao.maps.services){
    kakaoGeocoder = new kakao.maps.services.Geocoder();
    kakaoPs = new kakao.maps.services.Places();
    kakaoRvClient = new kakao.maps.RoadviewClient();
  }

  leftSelect.value = left.type; 
  rightSelect.value = right.type;

  bindUI();
  createMaps();
  renderHistory();
}

/* ===== ë§µ ìƒì„± ë° ê´€ë¦¬ ===== */
function createMaps(){
  createMap(left, "leftMap");
  createMap(right, "rightMap");
  
  bindEvents(left, right);
  bindEvents(right, left);
  
  bindRoadviewSync();
}

function createMap(side, containerId) {
  const el = document.getElementById(containerId);
  el.innerHTML = ""; 
  
  if(side.map) {
    if(side.type === "naver" && side.map.destroy) side.map.destroy();
    side.map = null;
    side.panorama = null;
    side.roadviewActive = false;
    side.gis = createGisState();
    side.naverState = { active: false, streetLayer: null, marker: null };
    side.searchMarker = null;
  }

  // --- 1. GOOGLE MAP ---
  if(side.type === "google") {
    const mapInner = document.createElement("div");
    mapInner.style.width = "100%"; mapInner.style.height = "100%";
    el.appendChild(mapInner);

    const panoDiv = document.createElement("div");
    panoDiv.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:15;display:none;";
    el.appendChild(panoDiv);

    const closeBtn = document.createElement("div");
    closeBtn.className = "close-btn-style";
    closeBtn.innerHTML = "Street ë‹«ê¸° X"; 
    el.appendChild(closeBtn);

    const map = new google.maps.Map(mapInner, {
      center: state, zoom: state.zoom, mapTypeId: "satellite",
      maxZoom: 21,
      // ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
      zoomControl: false,
      zoomControlOptions: { position: google.maps.ControlPosition.BOTTOM_LEFT },
      streetViewControl: true,
      streetViewControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT }
    });

    const coverageLayer = new google.maps.StreetViewCoverageLayer();
    const panorama = new google.maps.StreetViewPanorama(panoDiv, {
      enableCloseButton: false, visible: false, zoom: 1, pov: { heading: 0, pitch: 0 }
    });
    map.setStreetView(panorama);
    side.panorama = panorama;

    // [ìˆ˜ì •] ê±°ë¦¬ë·° ì‹¤í–‰ ì‹œ ë¯¸ë‹ˆë§µ ì¤‘ì‹¬ ë³´ì • ë¡œì§
    panorama.addListener("visible_changed", () => {
      if (panorama.getVisible()) {
        side.roadviewActive = true;
        panoDiv.style.display = "block";
        closeBtn.style.display = "block";
        mapInner.classList.add("minimap-style");
        coverageLayer.setMap(map);
        
        // ì¤‘ìš”: ë¦¬ì‚¬ì´ì¦ˆ íŠ¸ë¦¬ê±° í›„ ì¤‘ì‹¬ ì´ë™
        google.maps.event.trigger(map, "resize");
        setTimeout(() => map.setCenter(panorama.getPosition()), 50);
      } else {
        side.roadviewActive = false;
        panoDiv.style.display = "none";
        closeBtn.style.display = "none";
        mapInner.classList.remove("minimap-style");
        coverageLayer.setMap(null);
      }
      google.maps.event.trigger(map, "resize");
    });

    // [ìˆ˜ì •] í˜ê·¸ë§¨ ì´ë™ ì‹œ ë¯¸ë‹ˆë§µ ì¤‘ì‹¬ ë™ê¸°í™” (ë‚´ë¶€ ì—°ë™)
    panorama.addListener("position_changed", () => {
      if(side.roadviewActive) {
        map.setCenter(panorama.getPosition());
      }
    });

    closeBtn.onclick = () => panorama.setVisible(false);
    side.map = map;
  }

  // --- 2. KAKAO MAP ---
  else if(side.type === "kakao") {
    const wrapper = document.createElement("div");
    wrapper.style.cssText = "position:relative;width:100%;height:100%;";
    
    const rvDiv = document.createElement("div");
    rvDiv.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:#333;z-index:5;display:none;";
    
    const mapDiv = document.createElement("div");
    mapDiv.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;background:#eee;";
    
    const closeBtn = document.createElement("div");
    closeBtn.className = "close-btn-style";
    closeBtn.innerHTML = "ë¡œë“œë·° ë‹«ê¸° X";
    closeBtn.onclick = () => closeKakaoRoadview(side, rvDiv, mapDiv, closeBtn);

    const toolbar = document.createElement("div");
    toolbar.className = "kakao-toolbar";
    
    // [ìˆ˜ì •] íˆ´ë°” ë²„íŠ¼ ë°ì´í„° (ì´ë¯¸ì§€ ê²½ë¡œ ì ìš©)
    const btnData = [
      { id: 'roadview', text: 'ë¡œë“œë·°', img: './images/map_roadview20.jpg', action: () => toggleKakaoMode(side, 'roadview', wrapper) },
      { id: 'district', text: 'ì§€ì ë„', img: './images/map_cada20.jpg', action: () => toggleKakaoOverlay(side, 'district') },
      { id: 'distance', text: 'ê±°ë¦¬', img: './images/map_scale20.jpg', action: () => toggleKakaoMode(side, 'distance', wrapper) },
      { id: 'area', text: 'ë©´ì ', img: './images/map_area20.jpg', action: () => toggleKakaoMode(side, 'area', wrapper) },
      { id: 'clear', text: 'ì´ˆê¸°í™”', img: './images/map_trash20.jpg', class: 'delete-btn', action: () => clearKakaoMeasurements(side) }
    ];

    btnData.forEach(bd => {
      const btn = document.createElement("button");
      
      // ì´ë¯¸ì§€ ìƒì„± ë° ì¶”ê°€
      const img = document.createElement("img");
      img.src = bd.img;
      img.alt = bd.text;
      btn.appendChild(img);
      
      // íˆ´íŒ ì„¤ì • (ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ í…ìŠ¤íŠ¸ í‘œì‹œ)
      btn.title = bd.text; 

      if(bd.class) btn.className = bd.class;
      btn.setAttribute('data-mode', bd.id); 
      btn.onclick = bd.action;
      toolbar.appendChild(btn);
    });

    mapDiv.appendChild(toolbar);
    wrapper.appendChild(rvDiv);
    wrapper.appendChild(closeBtn);
    wrapper.appendChild(mapDiv);
    el.appendChild(wrapper);

    const map = new kakao.maps.Map(mapDiv, {
      center: new kakao.maps.LatLng(state.lat, state.lng),
      level: zoomToKakao(state.zoom)
    });
    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

    const rv = new kakao.maps.Roadview(rvDiv);
    side.panorama = rv; 

    kakao.maps.event.addListener(map, 'center_changed', () => syncFromKakao(side));
    kakao.maps.event.addListener(map, 'zoom_changed', () => syncFromKakao(side));
    
    kakao.maps.event.addListener(map, 'click', (e) => onKakaoMapClick(side, e, rvDiv, mapDiv, closeBtn));
    kakao.maps.event.addListener(map, 'mousemove', (e) => onKakaoMapMouseMove(side, e));
    kakao.maps.event.addListener(map, 'rightclick', (e) => onKakaoMapRightClick(side, e));

    kakao.maps.event.addListener(rv, 'position_changed', () => {
      // ë¡œë“œë·°ê°€ í™œì„±í™”ëœ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
      if (!side.roadviewActive) return; 

      const pos = rv.getPosition();
      if(side.gis.walker) {
        side.gis.walker.setPosition(pos);
      } else {
        side.gis.walker = new kakao.maps.CustomOverlay({
            position: pos,
            content: createWalkerContent(0),
            map: side.map
        });
      }
      map.setCenter(pos);
    });

    
    kakao.maps.event.addListener(rv, 'viewpoint_changed', () => {
      if (!side.roadviewActive) return; // í™œì„±í™” ìƒíƒœ ì²´í¬

      const vp = rv.getViewpoint();
      if(side.gis.walker) {
        side.gis.walker.setContent(createWalkerContent(vp.pan));
      }
    });

    side.map = map;
    side.dom = { wrapper, rvDiv, mapDiv, closeBtn, toolbar }; 
  }

  // --- 3. NAVER MAP ---
  else if(side.type === "naver") {
    const mapInner = document.createElement("div");
    mapInner.style.width = "100%"; mapInner.style.height = "100%";
    el.appendChild(mapInner);

    const panoDiv = document.createElement("div");
    panoDiv.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;z-index:15;visibility:hidden;";
    el.appendChild(panoDiv);

    const closeBtn = document.createElement("div");
    closeBtn.className = "close-btn-style";
    closeBtn.innerHTML = "ê±°ë¦¬ë·° ë‹«ê¸° X";
    el.appendChild(closeBtn);

    const streetBtn = document.createElement("div");
    streetBtn.className = "street-btn-style";
    streetBtn.innerHTML = "ê±°ë¦¬ë·°";
    mapInner.appendChild(streetBtn);

    const map = new naver.maps.Map(mapInner, {
        center: new naver.maps.LatLng(state.lat, state.lng),
        zoom: state.zoom, maxZoom: 21
    });

    const pano = new naver.maps.Panorama(panoDiv, {
        position: new naver.maps.LatLng(state.lat, state.lng),
        pov: { pan: 0, tilt: 0, fov: 100 }, visible: false
    });
    side.panorama = pano;

    const streetLayer = new naver.maps.StreetLayer();
    side.naverState.streetLayer = streetLayer;

    const marker = new naver.maps.Marker({
        position: map.getCenter(), map: null,
        icon: { content: '<div class="naver-marker-arrow"></div>', anchor: new naver.maps.Point(8, 10) }
    });
    side.naverState.marker = marker; 

    streetBtn.onclick = () => {
      if (side.naverState.active) {
        resetNaverRoadview();
      } else {
        side.naverState.active = true;
        streetLayer.setMap(map); 
        streetBtn.innerHTML = "ê±°ë¦¬ë·° ì·¨ì†Œ";
        streetBtn.style.background = "#4DC4FF";
        streetBtn.style.color = "white";
        map.setCursor('crosshair');
      }
    };

    function resetNaverRoadview() {
      side.naverState.active = false;
      side.roadviewActive = false; 
      streetLayer.setMap(null); 
      streetBtn.innerHTML = "ê±°ë¦¬ë·°";
      streetBtn.style.background = "#fff"; streetBtn.style.color = "#333";
      streetBtn.style.display = 'block';
      
      pano.setVisible(false);
      panoDiv.style.visibility = 'hidden';
      
      mapInner.classList.remove('minimap-style');
      closeBtn.style.display = 'none';
      
      marker.setMap(null);
      map.setCursor('default');
      setTimeout(() => naver.maps.Event.trigger(map, 'resize'), 100);
    }

    naver.maps.Event.addListener(map, 'click', (e) => {
      if (side.naverState.active && streetLayer.getMap()) {
        const newPos = e.coord;
        
        marker.setPosition(newPos);
        map.setCenter(newPos);
        map.setZoom(18);
        pano.setPosition(newPos);
        
        if (!mapInner.classList.contains('minimap-style')) {
            side.roadviewActive = true; 
            pano.setVisible(true);
            panoDiv.style.visibility = 'visible';
            mapInner.classList.add('minimap-style');
            closeBtn.style.display = 'block';
            streetBtn.style.display = 'none';
            marker.setMap(map);
            map.setCursor('default');
            naver.maps.Event.trigger(map, 'resize');
            
            setTimeout(() => {
                map.setCenter(newPos);
                map.setZoom(18); 
                streetLayer.setMap(map); 
            }, 150);
        }
      }
    });

    naver.maps.Event.addListener(pano, 'pano_changed', () => {
      const pos = pano.getPosition();
      marker.setPosition(pos);
      map.setCenter(pos); 
    });
    
    naver.maps.Event.addListener(pano, 'pov_changed', () => {
      const pov = pano.getPov();
      const arrow = mapInner.querySelector('.naver-marker-arrow');
      if(arrow) arrow.style.transform = `rotate(${pov.pan}deg)`;
    });

    closeBtn.onclick = resetNaverRoadview;

    naver.maps.Event.addListener(map, "idle", () => syncFromNaver(side));
    naver.maps.Event.addListener(map, 'center_changed', () => bindEvents(side, (side === left ? right : left)));
    naver.maps.Event.addListener(map, 'drag', () => bindEvents(side, (side === left ? right : left)));
    
    side.map = map;
  }
}

/* =========================================
   ì¹´ì¹´ì˜¤ GIS ë¡œì§
   ========================================= */
function toggleKakaoOverlay(side, type){
  if(!side.map) return;
  if(type === 'district') {
    const btn = side.dom.toolbar.querySelector('button[data-mode="district"]');
    if(btn.classList.contains('active')){
      side.map.removeOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
      btn.classList.remove('active');
    } else {
      side.map.addOverlayMapTypeId(kakao.maps.MapTypeId.USE_DISTRICT);
      btn.classList.add('active');
    }
  }
}

function toggleKakaoMode(side, mode, wrapper){
  if(!side.map) return;
  stopKakaoDrawing(side); 

  if(side.gis.mode === mode) {
    toggleKakaoMode(side, 'default', wrapper);
    return;
  }

  // [ìˆ˜ì •] ëª¨ë“œ ë³€ê²½ ì‹œ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” (ë‹¨, 'district'(ì§€ì ë„) ë²„íŠ¼ì€ ì œì™¸)
  const buttons = side.dom.toolbar.querySelectorAll('button');
  buttons.forEach(b => {
      if(b.getAttribute('data-mode') !== 'district') {
          b.classList.remove('active');
      }
  });
  
  const targetBtn = side.dom.toolbar.querySelector(`button[data-mode="${mode}"]`);
  if(targetBtn) targetBtn.classList.add('active');

  if(side.gis.mode === 'roadview' && mode !== 'roadview') {
    closeKakaoRoadview(side, side.dom.rvDiv, side.dom.mapDiv, side.dom.closeBtn);
  }

  side.gis.mode = mode;

  if(mode === 'roadview'){
    side.map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    if(!side.gis.statusEl){
      side.gis.statusEl = document.createElement('div');
      side.gis.statusEl.className = 'roadview-status';
      side.gis.statusEl.innerHTML = 'ğŸ“ ë¡œë“œë·° ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”';
      side.dom.mapDiv.appendChild(side.gis.statusEl);
    }
    side.map.setCursor('crosshair');
    side.gis.waiting = true; 
    side.roadviewActive = true; 
    // ì´ë¯¸ì§€ ë²„íŠ¼ì´ë¯€ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½ ë¡œì§ ìƒëµ
  } 
  else if (mode === 'distance' || mode === 'area') {
    side.map.setCursor('crosshair');
  } 
  else {
    side.map.setCursor('default');
  }
}

function onKakaoMapClick(side, mouseEvent, rvDiv, mapDiv, closeBtn){
  const pos = mouseEvent.latLng;

  if(side.gis.mode === 'roadview') {
    if(side.gis.waiting) {
      side.map.setCursor('default');
      side.gis.waiting = false;
      if(side.gis.statusEl) { side.gis.statusEl.remove(); side.gis.statusEl = null; }
      
      rvDiv.style.display = 'block';
      closeBtn.style.display = 'block';
      mapDiv.classList.add('minimap-style');
      
      setTimeout(() => {
        side.map.relayout();
        side.panorama.relayout();
        moveKakaoRoadview(side, pos);
      }, 300);
    } 
    else {
      moveKakaoRoadview(side, pos);
    }
    return;
  }

  if(side.gis.mode === 'distance' || side.gis.mode === 'area') {
    side.gis.path.push(pos);
    const marker = new kakao.maps.Marker({position:pos, map:side.map});
    side.gis.markers.push(marker);

    if(!side.gis.drawing) {
      if(side.gis.mode === 'distance') {
        side.gis.drawing = new kakao.maps.Polyline({
          map: side.map, path: [pos], strokeWeight:3, strokeColor:'#db4040', strokeOpacity:1, strokeStyle:'solid'
        });
      } else {
        side.gis.drawing = new kakao.maps.Polygon({
          map: side.map, path: [pos], strokeWeight:3, strokeColor:'#39f', strokeOpacity:0.8, strokeStyle:'longdash', fillColor:'#39f', fillOpacity:0.2
        });
      }
    } else {
      side.gis.drawing.setPath(side.gis.path);
      let content = '';
      if(side.gis.mode === 'distance') {
        content = `<div class="measure-label">${Math.round(side.gis.drawing.getLength()).toLocaleString()}m</div>`;
      } else if (side.gis.path.length >= 3) {
        content = `<div class="measure-label">${Math.round(side.gis.drawing.getArea()).toLocaleString()}mÂ²</div>`;
      }
      if(content) {
        const overlay = new kakao.maps.CustomOverlay({
          map: side.map, position: pos, content: content, yAnchor: 2.5
        });
        side.gis.overlays.push(overlay);
      }
    }
  }
}

function moveKakaoRoadview(side, pos) {
  kakaoRvClient.getNearestPanoId(pos, 50, (panoId) => {
    if(panoId) {
      side.panorama.setPanoId(panoId, pos);
      if(side.gis.walker) {
        side.gis.walker.setPosition(pos);
      } else if (side.roadviewActive) { 
        side.gis.walker = new kakao.maps.CustomOverlay({
            position: pos,
            content: createWalkerContent(0),
            map: side.map
        });
      }
      map.setCenter(pos);
    }
  });
}

function onKakaoMapMouseMove(side, mouseEvent) {
  if(!side.gis.drawing) return;
  const path = side.gis.path.slice();
  path.push(mouseEvent.latLng);
  side.gis.drawing.setPath(path);
}

function onKakaoMapRightClick(side, mouseEvent) {
  if(side.gis.mode === 'distance' || side.gis.mode === 'area') {
    if(side.gis.drawing && side.gis.path.length > 0) {
      const pos = mouseEvent.latLng;
      let content = '';
      if(side.gis.mode === 'distance') {
        content = `<div class="info-overlay">ì´ ê±°ë¦¬ <span style="font-weight:bold;color:#ee5555">${Math.round(side.gis.drawing.getLength()).toLocaleString()}m</span></div>`;
      } else {
        const area = Math.round(side.gis.drawing.getArea());
        content = `<div class="info-overlay">ì´ ë©´ì  <span style="font-weight:bold;color:#39f">${area.toLocaleString()}mÂ²</span><br>(${Number((area*0.3025).toFixed(1)).toLocaleString()}í‰)</div>`;
      }
      const overlay = new kakao.maps.CustomOverlay({ map: side.map, position: pos, content: content, yAnchor: 1 });
      side.gis.overlays.push(overlay);
      side.gis.shapes.push(side.gis.drawing);
      side.gis.drawing = null;
      side.gis.path = [];
    }
  } else {
    const pos = mouseEvent.latLng;
    kakaoGeocoder.coord2Address(pos.getLng(), pos.getLat(), (result, status) => {
      if(status === kakao.maps.services.Status.OK && result[0]) {
        const addr = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
        const contentHTML = `<div style="background:white;border:1px solid #444;padding:8px 10px;border-radius:6px;font-size:12px;box-shadow:1px 2px 4px rgba(0,0,0,0.3);">ğŸ“ ${addr}</div>`;
        const overlay = new kakao.maps.CustomOverlay({ map: side.map, position: pos, content: contentHTML, yAnchor: 2.0 });
        const marker = new kakao.maps.Marker({ position: pos, map: side.map });
        setTimeout(()=>{ overlay.setMap(null); marker.setMap(null); }, 5000);
      }
    });
  }
}

function closeKakaoRoadview(side, rvDiv, mapDiv, closeBtn){
  side.gis.mode = 'default';
  side.gis.waiting = false;
  side.roadviewActive = false;
  
  rvDiv.style.display = 'none';
  closeBtn.style.display = 'none';
  mapDiv.classList.remove('minimap-style');
  side.map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);

  const buttons = side.dom.toolbar.querySelectorAll('button');
  buttons.forEach(b => {
      if(b.getAttribute('data-mode') !== 'district') {
          b.classList.remove('active');
      }
  });

  if(side.gis.walker) { side.gis.walker.setMap(null); side.gis.walker = null; }
  if(side.gis.statusEl) { side.gis.statusEl.remove(); side.gis.statusEl = null; }

  side.map.setCursor('default');
  setTimeout(()=> side.map.relayout(), 300);
}

function clearKakaoMeasurements(side){
  side.gis.overlays.forEach(o => o.setMap(null));
  side.gis.shapes.forEach(s => s.setMap(null));
  side.gis.markers.forEach(m => m.setMap(null));
  // [ìˆ˜ì •] side ê°ì²´ì˜ ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
  if(side.searchMarker) { side.searchMarker.setMap(null); side.searchMarker = null; }
  if(kakaoSearchMarker) { kakaoSearchMarker.setMap(null); kakaoSearchMarker = null; }
  
  side.gis.overlays = []; side.gis.shapes = []; side.gis.markers = [];
  stopKakaoDrawing(side);
  toggleKakaoMode(side, 'default', side.dom.wrapper);
}

function stopKakaoDrawing(side){
  if(side.gis.drawing) { side.gis.drawing.setMap(null); side.gis.drawing = null; }
  side.gis.path = [];
}

function createWalkerContent(angle){
  return `<div class="MapWalker">
    <div class="angleBack" style="transform:rotate(${angle}deg);"></div>
    <div class="figure" style="transform:rotate(${angle}deg);"></div>
  </div>`;
}

/* =========================================
   ì™„ë²½í•œ ë¡œë“œë·° ìœ„ì¹˜ ë™ê¸°í™” (Angle Sync Removed)
   ========================================= */
function bindRoadviewSync() {
  if(left.panorama && right.panorama) {
    setupSync(left, right);
    setupSync(right, left);
  }

  function setupSync(fromSide, toSide) {
    const fromPano = fromSide.panorama;
    const toPano = toSide.panorama;
    const fromType = fromSide.type;
    const toType = toSide.type;

    let posEvent;
    if (fromType === 'kakao' || fromType === 'google') {
      posEvent = 'position_changed';
    } else if (fromType === 'naver') {
      posEvent = 'pano_changed';
    }

    // 1. ìœ„ì¹˜ ë™ê¸°í™” (Position Only)
    const onPosChange = () => {
      if (rvSyncing) return;
      
      let lat, lng;
      if (fromType === 'google') { const p = fromPano.getPosition(); lat = p.lat(); lng = p.lng(); }
      else if (fromType === 'naver') { const p = fromPano.getPosition(); lat = p.lat(); lng = p.lng(); } 
      else if (fromType === 'kakao') { const p = fromPano.getPosition(); lat = p.getLat(); lng = p.getLng(); }

      // ë£¨í”„ ë°©ì§€
      if (toType === 'naver') { 
          const p = toPano.getPosition(); 
          const curLat = p.lat(); const curLng = p.lng(); 
          const dist = Math.abs(curLat - lat) + Math.abs(curLng - lng);
          if(dist < 0.00001) return;
      }

      rvSyncing = true;

      // To ì ìš©
      if (toType === 'google') {
        toPano.setPosition({ lat, lng });
        releaseSync();
      } 
      else if (toType === 'naver') {
        const nPos = new naver.maps.LatLng(lat, lng);
        toPano.setPosition(nPos);
        // [ì¤‘ìš”] íƒ€ê²Ÿ ë„¤ì´ë²„ ë¯¸ë‹ˆë§µ & ë§ˆì»¤ ê°•ì œ ë™ê¸°í™”
        if(toSide.map) toSide.map.setCenter(nPos);
        if(toSide.naverState.marker) toSide.naverState.marker.setPosition(nPos);
        releaseSync(300);
      }
      else if (toType === 'kakao') {
        kakaoRvClient.getNearestPanoId(new kakao.maps.LatLng(lat, lng), 50, (panoId) => {
          if (panoId) {
            const newPos = new kakao.maps.LatLng(lat, lng);
            toPano.setPanoId(panoId, newPos);
            // [ì¤‘ìš”] íƒ€ê²Ÿ ì¹´ì¹´ì˜¤ ë¯¸ë‹ˆë§µ ê°•ì œ ë™ê¸°í™”
            if(toSide.map) toSide.map.setCenter(newPos);
            
            // [ìˆ˜ì •] íƒ€ê²Ÿ ì¹´ì¹´ì˜¤ë§µì´ ë¡œë“œë·° ëª¨ë“œì¼ ë•Œë§Œ Walker í‘œì‹œ
            if (toSide.roadviewActive) {
                if(toSide.gis.walker) {
                  toSide.gis.walker.setPosition(newPos);
                } else {
                  toSide.gis.walker = new kakao.maps.CustomOverlay({
                      position: newPos, content: createWalkerContent(0), map: toSide.map
                  });
                }
            }
          }
          releaseSync();
        });
      }
    };

    // [ì¤‘ìš”] Angle Sync Logic ì œê±°ë¨
    if(fromType === 'kakao') {
      kakao.maps.event.addListener(fromPano, posEvent, onPosChange);
    } else if(fromType === 'naver') {
      naver.maps.Event.addListener(fromPano, posEvent, onPosChange);
    } else { // Google
      fromPano.addListener(posEvent, onPosChange);
    }
  }

  function releaseSync(delay = 50) {
    setTimeout(() => { rvSyncing = false; }, delay);
  }
}

/* ===== ì¼ë°˜ ì§€ë„ ë™ê¸°í™” ===== */
function bindEvents(src, target){
  if(!src.map) return;
  
  const handleSync = () => {
    if(syncing || rvSyncing) return;
    syncing = true;
    
    let center, zoomLevel;
    if(src.type === 'google') {
      const c = src.map.getCenter(); center = {lat: c.lat(), lng: c.lng()}; zoomLevel = src.map.getZoom();
    } else if(src.type === 'kakao') {
      const c = src.map.getCenter(); center = {lat: c.getLat(), lng: c.getLng()}; zoomLevel = kakaoToZoom(src.map.getLevel());
    } else if(src.type === 'naver') {
      const c = src.map.getCenter(); center = {lat: c.y, lng: c.x}; zoomLevel = src.map.getZoom();
    }

    state.lat = center.lat; state.lng = center.lng; state.zoom = zoomLevel;
    applyTo(target);
    setTimeout(() => { syncing = false; }, 50);
  };

  if(src.type === 'google') {
    src.map.addListener('center_changed', handleSync); src.map.addListener('zoom_changed', handleSync);
  } else if(src.type === 'kakao') {
    kakao.maps.event.addListener(src.map, 'center_changed', handleSync); kakao.maps.event.addListener(src.map, 'zoom_changed', handleSync);
  } else if(src.type === 'naver') {
    naver.maps.Event.addListener(src.map, 'center_changed', handleSync);
    naver.maps.Event.addListener(src.map, 'zoom_changed', handleSync);
    naver.maps.Event.addListener(src.map, 'drag', handleSync);
  }
}

function syncFromKakao(side) { /* bindEventsë¡œ ëŒ€ì²´ */ }
function syncFromNaver(side) { /* bindEventsë¡œ ëŒ€ì²´ */ }

function applyTo(target){
  if(!target.map) return;
  
  // [ìˆ˜ì •] ê±°ë¦¬ë·° ì‹¤í–‰ ì¤‘ì—ë„ ë§µ ì—°ë™ì´ ë˜ë„ë¡ ì°¨ë‹¨ ì½”ë“œ ì£¼ì„ ì²˜ë¦¬
  // if(target.roadviewActive) return;

  if(target.type === "google"){
    target.map.setCenter(state); target.map.setZoom(state.zoom);
  } else if(target.type === "kakao"){
    target.map.setCenter(new kakao.maps.LatLng(state.lat, state.lng));
    target.map.setLevel(zoomToKakao(state.zoom));
  } else if(target.type === "naver"){
    target.map.setCenter(new naver.maps.LatLng(state.lat, state.lng));
    target.map.setZoom(state.zoom);
  }
}

function toggleType(side, btn){
  side.satellite = !side.satellite;
  if(!side.map) return;
  if(side.type === "google") side.map.setMapTypeId(side.satellite ? "satellite" : "roadmap");
  if(side.type === "kakao") side.map.setMapTypeId(side.satellite ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP);
  if(side.type === "naver") side.map.setMapTypeId(side.satellite ? naver.maps.MapTypeId.SATELLITE : naver.maps.MapTypeId.NORMAL);
}

function zoomToKakao(z){ return Math.max(1, Math.min(14, 20-z)); }
function kakaoToZoom(l){ return Math.max(3, Math.min(20, 20-l)); }

/* ===== ê²€ìƒ‰ ë° UI ===== */
function bindUI(){
  leftSelect.onchange = () => { left.type = leftSelect.value; createMaps(); };
  rightSelect.onchange = () => { right.type = rightSelect.value; createMaps(); };
  
  leftType.onclick = () => toggleType(left, leftType);
  rightType.onclick = () => toggleType(right, rightType);

  const input = document.getElementById("searchInput");
  const btn = document.getElementById("searchBtn");
  const clearBtn = document.getElementById("clearSearchBtn");
  const historySelect = document.getElementById('historySelect');
  const suggestList = document.getElementById("suggestList");

  const doSearch = () => {
    const q = input.value.trim();
    if(q) searchKeyword(q);
    suggestList.style.display = "none";
  };

  btn.onclick = doSearch;

  input.addEventListener("keydown", e => {
    const items = suggestList.querySelectorAll("div");
    if (suggestList.style.display === "block" && items.length > 0) {
        if (e.key === "ArrowDown") {
            e.preventDefault();
            activeSuggestIndex++;
            if (activeSuggestIndex >= items.length) activeSuggestIndex = 0;
            updateActiveItem(items);
        } else if (e.key === "ArrowUp") {
            e.preventDefault();
            activeSuggestIndex--;
            if (activeSuggestIndex < 0) activeSuggestIndex = items.length - 1;
            updateActiveItem(items);
        } else if (e.key === "Enter") {
            e.preventDefault();
            if (activeSuggestIndex > -1) {
                items[activeSuggestIndex].click();
            } else {
                doSearch();
            }
        }
    } else if (e.key === "Enter") {
        doSearch();
    }
  });

  function updateActiveItem(items) {
      items.forEach(item => item.classList.remove("active"));
      if (activeSuggestIndex > -1 && items[activeSuggestIndex]) {
          items[activeSuggestIndex].classList.add("active");
          items[activeSuggestIndex].scrollIntoView({ block: "nearest" });
          input.value = items[activeSuggestIndex].textContent; 
      }
  }

  // [ìˆ˜ì •] ê²€ìƒ‰ì°½ ì§€ì›€ ë²„íŠ¼ ë¡œì§ ë³€ê²½
  clearBtn.onclick = () => {
    input.value = "";
    // ì „ì—­ ë³€ìˆ˜ ëŒ€ì‹  ê° side ê°ì²´ì˜ ë§ˆì»¤ë¥¼ í™•ì¸í•˜ì—¬ ì œê±°
    [left, right].forEach(side => {
        if (side.searchMarker) {
            side.searchMarker.setMap(null);
            side.searchMarker = null;
        }
    });
    // ë ˆê±°ì‹œ ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    if(kakaoSearchMarker) { kakaoSearchMarker.setMap(null); kakaoSearchMarker = null; }
  };

  historySelect.addEventListener('change', function() {
    if(this.value !== "") {
      const item = searchHistory[this.value];
      moveToLocation(item.lat, item.lng);
      input.value = item.name;
      this.value = "";
    }
  });
  
  // ìë™ì™„ì„±
  input.addEventListener("input",()=>{
    const q=input.value.trim();
    activeSuggestIndex = -1;
    if(!q){ suggestList.style.display="none"; return; }
    if(kakaoPs){
      kakaoPs.keywordSearch(q,(r,s)=>{
        if(s!==kakao.maps.services.Status.OK || !r.length){ suggestList.style.display="none"; return; }
        suggestList.innerHTML="";
        r.slice(0,10).forEach((item, idx)=>{
          const div=document.createElement("div");
          div.textContent=item.place_name+(item.road_address_name?" ("+item.road_address_name+")":"");
          div.onclick=()=>{
            moveToLocation(item.y, item.x);
            suggestList.style.display="none";
            input.value=item.place_name;
            addToHistory(item.place_name, item.y, item.x);
          };
          suggestList.appendChild(div);
        });
        suggestList.style.display="block";
      });
    }
  });

  document.addEventListener("click", e => {
      if (!e.target.closest(".panel")) {
          suggestList.style.display = "none";
      }
  });
}

function moveToLocation(lat, lng) {
  state.lat = parseFloat(lat); state.lng = parseFloat(lng); state.zoom = 18;
  applyTo(left); applyTo(right);
  showSearchMarkers(lat, lng);
}

// [ìˆ˜ì •] ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜: ì „ì—­ ë³€ìˆ˜ ì˜ì¡´ì„±ì„ ì œê±°í•˜ê³  ìë£Œí˜• ë¬¸ì œ í•´ê²°
function showSearchMarkers(lat, lng) {
  [left, right].forEach(side => {
    if(!side.map) return;

    // 1. ê¸°ì¡´ ë§ˆì»¤ ì œê±°
    if (side.searchMarker) {
        side.searchMarker.setMap(null);
        side.searchMarker = null;
    }

    let marker = null;

    // 2. êµ¬ê¸€ë§µ: lat, lngë¥¼ Numberë¡œ ë³€í™˜
    if(side.type === 'google') {
        marker = new google.maps.Marker({ 
            position: { lat: parseFloat(lat), lng: parseFloat(lng) }, 
            map: side.map 
        });
    }
    // 3. ë„¤ì´ë²„ë§µ
    else if(side.type === 'naver') {
        marker = new naver.maps.Marker({ 
            position: new naver.maps.LatLng(lat, lng), 
            map: side.map 
        });
    }
    // 4. ì¹´ì¹´ì˜¤ë§µ
    else if(side.type === 'kakao') {
        marker = new kakao.maps.Marker({ 
            position: new kakao.maps.LatLng(lat, lng), 
            map: side.map 
        });
    }

    // 5. ìƒì„±ëœ ë§ˆì»¤ ì €ì¥
    side.searchMarker = marker;
  });
}

function addToHistory(name, lat, lng) {
  searchHistory = searchHistory.filter(i => i.name !== name);
  searchHistory.unshift({ name, lat, lng });
  if(searchHistory.length > 7) searchHistory.pop();
  localStorage.setItem('mapSearchHistory', JSON.stringify(searchHistory));
  renderHistory();
}

function renderHistory() {
  const el = document.getElementById('historySelect');
  el.innerHTML = '<option value="">ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡</option>';
  searchHistory.forEach((item, idx) => {
    const opt = document.createElement('option');
    opt.value = idx; opt.text = item.name;
    el.appendChild(opt);
  });
}

function searchKeyword(q){
  if(!kakaoGeocoder) return;
  kakaoGeocoder.addressSearch(q, (res, status) => {
    if(status === kakao.maps.services.Status.OK) {
      moveToLocation(res[0].y, res[0].x);
      addToHistory(res[0].address_name, res[0].y, res[0].x);
    } else {
      kakaoPs.keywordSearch(q, (r, s) => {
        if(s === kakao.maps.services.Status.OK) {
          moveToLocation(r[0].y, r[0].x);
          addToHistory(r[0].place_name, r[0].y, r[0].x);
        }
      });
    }
  });
}
</script>
</body>

</html>

